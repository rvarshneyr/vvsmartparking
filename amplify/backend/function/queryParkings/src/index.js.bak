'use strict'
const AWS = require('aws-sdk')
const ddbGeo = require('dynamodb-geo') // Geo library of Amazon DynamoDB
AWS.config.update({ region: "us-east-2" })
const uuid = require('uuid');

// Update GeoDataManagerConfiguration in Geolibrary 
const DDB_TABLENAME = 'parkingmeters';
const ddb = new AWS.DynamoDB();
const config = new ddbGeo.GeoDataManagerConfiguration(ddb, DDB_TABLENAME);
config.rangeKeyAttributeName = 'timestamp';

const myGeoTableManager = new ddbGeo.GeoDataManager(config);


/**
 * @type {import('@types/aws-lambda').APIGatewayProxyHandler}
 */
exports.handler = async (event, context) => {
    let response;
    var results = Array();
    try {

        // Querying 100km from Cambridge, UK
        await myGeoTableManager.queryRadius({
            RadiusInMeter: 100,
            CenterPoint: {
                latitude: -32.8645,
                longitude: 25.9577
            },
            //ScanIndexFotrward: false,
            //Limit: "1"
        })
            // return results, an array of DynamoDB.AttributeMaps
            .then(parkings => {
                console.log("number of open slots" + parkings.length.toString());
                parkings.forEach(function (record) {
                    var unmarshalledrecord = AWS.DynamoDB.Converter.unmarshall(record);
                    if (unmarshalledrecord.isOccupied == false) {
                        var unmarshalledlocation = unmarshalledrecord.location.values;
                        var meterdata = {
                            address: unmarshalledrecord.address,
                            number: unmarshalledrecord.number,
                            isOccupied: unmarshalledrecord.isOccupied,
                            location: unmarshalledlocation
                        };
                        if (!results.includes(meterdata)) {
                            results.push(meterdata);
                        }
                    }
                })
                console.log(JSON.stringify(results));
            })

        response = {
            'statusCode': 200,
            'body': JSON.stringify({
                openParkings: results,
            })
        }

    } catch (err) {
        console.log(err);
        return err;
    }
    return response;
};